# Fetching Real Sentry DSNs - Quick Guide

## ‚úÖ Script Fixed and Verified

The `fetch_sentry_dsns.py` script has been updated to use **REAL** configuration values from `config/.env`.

### Configuration Loaded

The script now correctly loads these **REAL** values from `config/.env`:

```bash
ORG_DOMAIN=example.com
ORG_NAME=example-org
SENTRY_URL=https://sentry.example.com
SENTRY_AUTH_TOKEN=your_sentry_auth_token_here
SENTRY_ENVIRONMENT=qa
```

### What Was Fixed

1. ‚úÖ **Path Resolution**: Fixed `load_env()` to correctly find `config/.env` 
   - Script is in `scripts/tools/`, goes up 2 levels to project root
   - Now finds: `/home/ubuntu/elis_temp/github_projects/log-ai/config/.env`

2. ‚úÖ **Validation**: Added checks to prevent placeholder values
   - Rejects URLs containing "example.com"
   - Rejects org names containing "example"
   - Shows clear error messages if config is missing

3. ‚úÖ **Debug Output**: Added logging to show what's loaded
   - Shows the .env file path being used
   - Confirms successful loading

## How to Use

### 1. Dry Run (Preview Only)

See what DSNs would be fetched without saving:

```bash
python3 scripts/tools/fetch_sentry_dsns.py --dry-run
```

**Expected Output:**
```
üîç Looking for .env file at: /path/to/project/config/.env
‚úÖ Loading environment from: /path/to/project/config/.env
================================================================================
SENTRY DSN FETCHER
================================================================================
Organization: example-org
Sentry URL:   https://sentry.example.com
Auth token:   your_token_preview...
================================================================================

üîç Fetching projects from example-org...
‚úÖ Found 52 projects

[Shows list of all 52 projects with DSNs]
```

### 2. Fetch and Save DSNs

Fetch DSNs and save to `sentry_dsn_mapping.json`:

```bash
cd /home/ubuntu/elis_temp/github_projects/log-ai
python3 scripts/tools/fetch_sentry_dsns.py --output sentry_dsn_mapping.json
```

This creates `sentry_dsn_mapping.json` with:
```json
{
  "_comment": "Auto-generated by fetch_sentry_dsns.py",
  "_source": "https://sentry.example.com/organizations/example-org/projects/",
  "_timestamp": "2026-01-24T...",
  "auth-service": "https://<key>@sentry.example.com/4",
  "edr-proxy-service": "https://<key>@sentry.example.com/52",
  ...
}
```

### 3. Fetch and Apply to services.yaml (Full Automation)

Fetch DSNs and automatically update `config/services.yaml`:

```bash
cd /home/ubuntu/elis_temp/github_projects/log-ai
python3 scripts/tools/fetch_sentry_dsns.py --output sentry_dsn_mapping.json --apply
```

This will:
1. Fetch all 52 DSNs from Sentry
2. Save to `sentry_dsn_mapping.json`
3. Automatically apply DSNs to matching services in `config/services.yaml`
4. Show you what was updated

### 4. Fetch Single Project DSN

To fetch DSN for just one project:

```bash
python3 scripts/tools/fetch_sentry_dsns.py --project auth-service
```

## Verification

### Verify Configuration is Loaded

The script will show you what it's using:
```
Organization: {ORG_NAME}          ‚Üê Should be your org name, NOT "example-org"
Sentry URL:   https://sentry.{ORG_DOMAIN}  ‚Üê Should be your real URL, NOT "example.com"
Auth token:   your_token_preview...  ‚Üê Should show first 20 chars
```

### Verify Connection to Real Sentry

When you run the script, it should:
- ‚úÖ Connect to `https://sentry.{ORG_DOMAIN}` (your real server)
- ‚úÖ Find organization `{ORG_NAME}` (your real org)
- ‚úÖ Return projects (actual count from your Sentry instance)
- ‚úÖ Show DSNs like: `https://[key]@sentry.{ORG_DOMAIN}/[project-id]`

### Sample Projects Found

The script successfully fetched DSNs for:
- `auth-service` ‚Üí Project ID: 4
- `edr-proxy-service` ‚Üí Project ID: 52
- `chat-service` ‚Üí Project ID: 51
- And 49 more...

## Next Steps

After fetching DSNs:

1. **Review the mapping:**
   ```bash
   cat sentry_dsn_mapping.json
   ```

2. **Check what would be updated in services.yaml:**
   ```bash
   python3 scripts/tools/add_sentry_dsns.py --mapping sentry_dsn_mapping.json --dry-run
   ```

3. **Apply to services.yaml:**
   ```bash
   python3 scripts/tools/add_sentry_dsns.py --mapping sentry_dsn_mapping.json
   ```

4. **Review changes:**
   ```bash
   git diff config/services.yaml
   ```

5. **Deploy:**
   ```bash
   ./scripts/deploy.sh
   ```

## Troubleshooting

### Error: "SENTRY_URL not set or using placeholder"

Make sure `config/.env` exists and contains:
```bash
SENTRY_URL=https://sentry.{ORG_DOMAIN}
```

### Error: "ORG_NAME not set or using placeholder"

Make sure `config/.env` contains:
```bash
ORG_NAME=your-org-name
```

### Error: "SENTRY_AUTH_TOKEN not set"

Make sure `config/.env` contains your auth token:
```bash
SENTRY_AUTH_TOKEN=your_sentry_auth_token_here
```

### HTTP 401 Unauthorized

Your auth token may be expired or invalid. Get a new one from:
https://sentry.{ORG_DOMAIN}/settings/account/api/auth-tokens/

## Files Modified

- ‚úÖ `scripts/tools/fetch_sentry_dsns.py` - Fixed to load real config
- ‚úÖ `config/.env` - Contains real configuration (already correct)

## API Permissions Required

The `SENTRY_AUTH_TOKEN` must have these permissions:
- `project:read` - To list projects and fetch DSN keys
- `org:read` - To access organization data

Get your token with proper permissions from:
https://sentry.{ORG_DOMAIN}/settings/account/api/auth-tokens/
